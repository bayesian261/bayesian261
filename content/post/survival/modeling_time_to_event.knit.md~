---
title: "Time to event models"
author: "Bongani Ncube"
date: "2023-08-23"
output:
  html_document:
    df_print: paged
categories: []
tags: []
summary: ''
authors: []
lastmod: "2023-08-17T19:38:55+02:00"
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
subtitle: Cox Proportional Hazards
---




```
## 
## ##################################################################
## ##                           Welcome:                           ##
## ##                     Data Science hangout                     ##
## ##################################################################
```

# About the Author<U+0001F468><U+200D><U+0001F393><U+0001F393>

Bongani Ncube is a Data Scientist with a background in mathematical statistics . I have expertise in statistical modeling ,data analysis and data visualisation using R programming language . I am the founder of `Neat Elite Research and Data Analytics consultancy` which is a analytics consultancy that helps students and companies draw insights from their data .

> My current interests are using R and Rstudio in a practical data science context. I help people people manage data from gathering,cleaning ,analysis ,modeling and visualizing . I help people from backgrounds such as SQL and python kickstart their journey of using R and conduct trainings for the following packages.

-   Tidymodels
-   Tidyverse
-   data.table
-   Rmarkdown

Contact {#contact}
--------------------------------------------------------------------------------

- <i class="fa fa-envelope"></i> [Email](mailto:r195334vncube@gmail.com)
- <i class="fa fa-github"></i> [Github Profile](https://github.com/bayesian261)
- <i class="fa fa-linkedin"></i> [LinkedIn Profile](https://www.linkedin.com/in/ncube-bongani-b90094210/)
- <i class="fa fa-phone"></i> + 263 77 497 9514
- <i class="fa fa-home"></i> Harare, Zimbabwe


Selected Certificates {data-icon=certificate data-concise=true}
--------------------------------------------------------------------------------

### Machine Learning Scientist With an R track
[View certificate](https://www.datacamp.com/statement-of-accomplishment/track/25b6113cff605043f45a51720cfbcb68068016f4?raw=1)


### Definitions

**Survival analysis** lets you analyze the rates of occurrence of events over time, without assuming the rates are constant. Generally, survival analysis lets you model the _time until an event occurs_,[^deathvs] or compare the time-to-event between different groups, or how time-to-event correlates with quantitative variables.

The **hazard** is the instantaneous event (death) rate at a particular time point _t_. Survival analysis doesn't assume the hazard is constant over time. The _cumulative hazard_ is the total hazard experienced up to time _t_.

The **survival function**, is the probability an individual survives (or, the probability that the event of interest does not occur) up to and including time _t_. It's the probability that the event (e.g., death) hasn't occured yet. It looks like this, where $T$ is the time of death, and $Pr(T>t)$ is the probability that the time of death is greater than some time $t$. $S$ is a probability, so $0 \leq S(t) \leq 1$, since survival times are always positive ($T \geq 0$).

$$ S(t) = Pr(T>t) $$


The **Kaplan-Meier** curve illustrates the survival function. It's a step function illustrating the cumulative survival probability over time. The curve is horizontal over periods where no event occurs, then drops vertically corresponding to a change in the survival function at each time an event occurs. 

**Censoring** is a type of missing data problem unique to survival analysis. This happens when you track the sample/subject through the end of the study and the event never occurs. This could also happen due to the sample/subject dropping out of the study for reasons other than death, or some other loss to followup. The sample is _censored_ in that you only know that the individual survived up to the loss to followup, but you don't know anything about survival after that.[^censoring]

[^censoring]: This describes the most common type of censoring -- _right censoring_. _Left censoring_ less commonly occurs when the "start" is unknown, such as when an initial diagnosis or exposure time is unknown. 

**Proportional hazards assumption**: The main goal of survival analysis is to compare the survival functions in different groups, e.g., leukemia patients as compared to cancer-free controls. If you followed both groups until everyone died, both survival curves would end at 0%, but one group might have survived on average a lot longer than the other group. Survival analysis does this by comparing the _hazard_ at different times over the observation period. Survival analysis doesn't assume that the hazard is constant, but _does_ assume that the _ratio_ of hazards between groups is constant over time.[^cumhaz] This class does _not_ cover methods to deal with non-proportional hazards, or interactions of covariates with the time to event.

[^cumhaz]: And, following the definitions above, assumes that the _cumulative hazard_ ratio between two groups remains constant over time.

**Proportional hazards regression** a.k.a. **Cox regression** is the most common approach to assess the effect of different variables on survival. 

### Cox PH Model

Kaplan-Meier curves are good for visualizing differences in survival between two categorical groups,[^logrank] but they don't work well for assessing the effect of _quantitative_ variables like age, gene expression, leukocyte count, etc. Cox PH regression can assess the effect of both categorical and continuous variables, and can model the effect of multiple variables at once.[^multregression]

# functions

The core functions we'll use out of the survival package include:

- `Surv()`: Creates a survival object.
- `survfit()`: Fits a survival curve using either a formula, of from a previously fitted Cox model.
- `coxph()`: Fits a Cox proportional hazards regression model.

Other optional functions you might use include: 

- `cox.zph()`: Tests the proportional hazards assumption of a Cox regression model.
- `survdiff()`: Tests for differences in survival between two groups using a log-rank / Mantel-Haenszel test.[^survdiff]

[^survdiff]: Cox regression and the logrank test from `survdiff` are going to give you similar results most of the time. The log-rank test is asking if survival curves differ significantly between two groups. Cox regression is asking which of many categorical or continuous variables significantly affect survival. 

`Surv()` creates the response variable, and typical usage takes the time to event,[^time2] and whether or not the event occured (i.e., death vs censored). `survfit()` creates a survival curve that you could then display or plot. `coxph()` implements the regression analysis, and models specified the same way as in regular linear models, but using the `coxph()` function.


# Data description

- status : event at discharge (alive or dead)        
- sex : male or female          
- dm : diabetes (yes or no)           
- gcs : Glasgow Coma Scale (value from 3 to 15)          
- sbp : Systolic blood pressure (mmHg)           
- dbp : Diastolic blood pressure (mmHg)          
- wbc : Total white cell count           
- time2 : days in ward         
- stroke_type : stroke type (Ischaemic stroke or Haemorrhagic stroke)  
- referral_from : patient was referred from a hospital or not from a hospital

# setup

```r
# load in packages
library(tidyverse)
```

```
## Warning: package 'ggplot2' was built under R version 4.2.3
```

```
## Warning: package 'tibble' was built under R version 4.2.3
```

```
## Warning: package 'dplyr' was built under R version 4.2.3
```

```
## -- Attaching core tidyverse packages ------------------------ tidyverse 2.0.0 --
## v dplyr     1.1.2     v readr     2.1.4
## v forcats   1.0.0     v stringr   1.5.0
## v ggplot2   3.4.2     v tibble    3.2.1
## v lubridate 1.9.2     v tidyr     1.3.0
## v purrr     1.0.1     
## -- Conflicts ------------------------------------------ tidyverse_conflicts() --
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()
## i Use the ]8;;http://conflicted.r-lib.org/conflicted package]8;; to force all conflicts to become errors
```

```r
library(haven)
library(rms)
```

```
## Loading required package: Hmisc
## 
## Attaching package: 'Hmisc'
## 
## The following objects are masked from 'package:dplyr':
## 
##     src, summarize
## 
## The following objects are masked from 'package:base':
## 
##     format.pval, units
## 
## Loading required package: survival
## Loading required package: lattice
## Loading required package: SparseM
## 
## Attaching package: 'SparseM'
## 
## The following object is masked from 'package:base':
## 
##     backsolve
```

```r
library(broom)
library(survival)
library(survminer)
```

```
## Loading required package: ggpubr
## 
## Attaching package: 'survminer'
## 
## The following object is masked from 'package:survival':
## 
##     myeloma
```

```r
library(data.table)
```

```
## 
## Attaching package: 'data.table'
## 
## The following objects are masked from 'package:lubridate':
## 
##     hour, isoweek, mday, minute, month, quarter, second, wday, week,
##     yday, year
## 
## The following objects are masked from 'package:dplyr':
## 
##     between, first, last
## 
## The following object is masked from 'package:purrr':
## 
##     transpose
```

```r
library(DT)

stroke <- read_csv('stroke_data.csv')
```

```
## Rows: 213 Columns: 12
## -- Column specification --------------------------------------------------------
## Delimiter: ","
## chr (7): doa, dod, status, sex, dm, stroke_type, referral_from
## dbl (5): gcs, sbp, dbp, wbc, time2
## 
## i Use `spec()` to retrieve the full column specification for this data.
## i Specify the column types or set `show_col_types = FALSE` to quiet this message.
```


```r
datatable(head(stroke,50), style="bootstrap", class="table-condensed",
          options = list(dom = 'tp', scrollX = TRUE))
```

```{=html}
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-5574c2c1eecc2ca8d736" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-5574c2c1eecc2ca8d736">{"x":{"style":"bootstrap","filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50"],["17/2/2011","20/3/2011","9/4/2011","12/4/2011","12/4/2011","4/5/2011","22/5/2011","23/5/2011","11/7/2011","4/9/2011","12/10/2011","21/10/2011","26/10/2011","28/11/2011","29/12/2011","15/1/2012","16/1/2012","22/2/2012","9/3/2012","17/3/2012","25/3/2012","2/4/2012","25/5/2012","31/1/2011","6/2/2011","7/2/2011","20/2/2011","15/3/2011","19/6/2011","9/8/2011","17/8/2011","21/8/2011","2/9/2011","8/9/2011","2/10/2011","31/10/2011","1/11/2011","12/12/2011","22/12/2011","4/2/2012","9/2/2012","14/2/2012","27/2/2012","3/3/2012","23/3/2012","29/5/2012","13/6/2012","3/1/2011","15/2/2011","12/3/2011"],["18/2/2011","21/3/2011","10/4/2011","13/4/2011","13/4/2011","5/5/2011","23/5/2011","24/5/2011","12/7/2011","5/9/2011","13/10/2011","22/10/2011","27/10/2011","29/11/2011","30/12/2011","16/1/2012","17/1/2012","23/2/2012","10/3/2012","18/3/2012","26/3/2012","3/4/2012","26/5/2012","2/2/2011","8/2/2011","9/2/2011","22/2/2011","17/3/2011","21/6/2011","11/8/2011","19/8/2011","23/8/2011","4/9/2011","10/9/2011","4/10/2011","2/11/2011","3/11/2011","14/12/2011","24/12/2011","6/2/2012","11/2/2012","16/2/2012","29/2/2012","5/3/2012","25/3/2012","31/5/2012","15/6/2012","6/1/2011","18/2/2011","15/3/2011"],["alive","alive","dead","dead","alive","dead","alive","alive","dead","alive","alive","alive","dead","dead","alive","dead","alive","dead","alive","alive","alive","alive","dead","alive","alive","dead","alive","alive","alive","alive","alive","alive","dead","dead","alive","alive","alive","alive","alive","alive","alive","alive","alive","alive","alive","alive","dead","alive","dead","alive"],["male","male","female","male","female","female","male","female","female","female","female","male","female","male","female","female","female","male","female","female","male","male","female","male","male","female","male","male","female","male","female","male","female","female","male","female","female","male","male","male","male","female","female","male","female","male","female","male","female","male"],["no","no","no","no","yes","no","no","yes","yes","no","no","no","no","no","no","no","no","no","no","yes","no","no","no","no","no","no","no","yes","no","no","no","yes","no","no","yes","no","no","no","no","no","no","no","no","no","yes","no","no","no","yes","no"],[15,15,11,3,15,3,11,15,6,15,15,4,4,10,12,13,15,7,10,15,14,15,11,15,15,9,15,15,15,15,15,15,3,15,15,15,15,14,15,15,15,14,15,15,15,15,9,15,12,15],[151,196,126,170,103,91,171,106,170,123,144,230,207,207,178,178,119,150,207,147,128,143,200,161,153,200,143,116,108,132,233,162,98,97,232,124,214,144,176,143,134,157,188,143,186,178,162,152,182,138],[73,123,78,103,62,55,80,67,90,83,89,120,120,128,100,75,67,80,109,84,79,59,110,107,61,104,93,81,74,81,116,72,42,53,146,82,117,88,112,76,75,85,85,90,139,104,79,108,83,78],[12.5,8.1,15.3,13.9,14.7,14.2,8.7,5.5,10.5,7.2,5.7,12.7,16.5,10.8,8.8,9.5,4.2,15.5,10.1,13.1,10.3,7.1,14.2,9.5,11.2,7.2,15.6,11,13.7,7.2,7.2,7.5,13.7,10.1,8.5,6.5,6.6,9.3,5.8,8.2,9,11.8,5,6.8,7.1,9.5,10.1,7.4,9,6.7],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3],["IS","IS","HS","IS","IS","HS","IS","IS","HS","IS","IS","IS","HS","HS","HS","IS","IS","HS","HS","IS","IS","IS","IS","IS","IS","IS","IS","IS","IS","IS","IS","IS","HS","IS","IS","IS","IS","HS","IS","IS","HS","IS","IS","IS","IS","IS","IS","IS","HS","IS"],["non-hospital","non-hospital","hospital","hospital","non-hospital","hospital","hospital","non-hospital","hospital","non-hospital","non-hospital","hospital","non-hospital","non-hospital","hospital","non-hospital","non-hospital","hospital","hospital","non-hospital","non-hospital","non-hospital","hospital","non-hospital","non-hospital","hospital","non-hospital","non-hospital","non-hospital","non-hospital","non-hospital","non-hospital","hospital","non-hospital","non-hospital","non-hospital","non-hospital","hospital","non-hospital","non-hospital","non-hospital","hospital","non-hospital","hospital","non-hospital","hospital","hospital","non-hospital","hospital","non-hospital"]],"container":"<table class=\"table table-condensed\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>doa<\/th>\n      <th>dod<\/th>\n      <th>status<\/th>\n      <th>sex<\/th>\n      <th>dm<\/th>\n      <th>gcs<\/th>\n      <th>sbp<\/th>\n      <th>dbp<\/th>\n      <th>wbc<\/th>\n      <th>time2<\/th>\n      <th>stroke_type<\/th>\n      <th>referral_from<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"tp","scrollX":true,"columnDefs":[{"className":"dt-right","targets":[6,7,8,9,10]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
```


# The survival probabilities for all patients:




```r
>KM <- survfit(Surv(time = time2,event = status == "dead" ) ~ 1, 
              data = stroke)
>summary(KM)
Call: survfit(formula = Surv(time = time2, event = status == "dead") ~ 
    1, data = stroke)

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    1    213       9    0.958  0.0138       0.9311        0.985
    2    190       4    0.938  0.0168       0.9053        0.971
    3    166       4    0.915  0.0198       0.8770        0.955
    4    130       4    0.887  0.0237       0.8416        0.934
    5     90       5    0.838  0.0310       0.7790        0.901
    6     65       3    0.799  0.0367       0.7301        0.874
    7     56       4    0.742  0.0438       0.6608        0.833
    9     42       1    0.724  0.0462       0.6391        0.821
   10     37       1    0.705  0.0489       0.6150        0.807
   12     33       4    0.619  0.0587       0.5142        0.746
   14     24       2    0.568  0.0642       0.4548        0.708
   18     19       1    0.538  0.0674       0.4206        0.687
   22     15       1    0.502  0.0718       0.3792        0.664
   25      9       2    0.390  0.0892       0.2494        0.611
   28      5       1    0.312  0.0998       0.1669        0.584
   29      4       1    0.234  0.1009       0.1007        0.545
   41      2       1    0.117  0.0970       0.0231        0.593
```

# Next, we will estimate the survival probabilities for stroke type: 


```r
>KM_str_type2 <- survfit(Surv(time = time2, 
                             event = status == "dead" ) ~ stroke_type, 
                        data = stroke)
>summary(KM_str_type2)

Call: survfit(formula = Surv(time = time2, event = status == "dead") ~ 
    stroke_type, data = stroke)

                stroke_type=HS 
 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    1     69       6    0.913  0.0339       0.8489        0.982
    2     61       1    0.898  0.0365       0.8293        0.973
    3     58       4    0.836  0.0453       0.7520        0.930
    4     52       2    0.804  0.0489       0.7136        0.906
    5     47       4    0.736  0.0554       0.6346        0.853
    6     38       2    0.697  0.0589       0.5905        0.822
    7     34       2    0.656  0.0621       0.5447        0.790
    9     30       1    0.634  0.0638       0.5205        0.772
   10     27       1    0.611  0.0656       0.4945        0.754
   12     24       2    0.560  0.0693       0.4390        0.713
   14     19       1    0.530  0.0717       0.4068        0.691
   18     15       1    0.495  0.0751       0.3675        0.666
   22     11       1    0.450  0.0806       0.3166        0.639
   25      6       2    0.300  0.1019       0.1541        0.584
   29      2       1    0.150  0.1176       0.0322        0.698
```
#


```r
stroke_type=IS 
 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    1    144       3    0.979  0.0119        0.956        1.000
    2    129       3    0.956  0.0174        0.923        0.991
    4     78       2    0.932  0.0241        0.886        0.980
    5     43       1    0.910  0.0318        0.850        0.975
    6     27       1    0.876  0.0451        0.792        0.970
    7     22       2    0.797  0.0676        0.675        0.941
   12      9       2    0.620  0.1223        0.421        0.912
   14      5       1    0.496  0.1479        0.276        0.890
   28      3       1    0.331  0.1671        0.123        0.890
   41      1       1    0.000     NaN           NA           NA
```

## Plot the survival probability 

The KM estimate provides the survival probabilities. We can plot these probabilities to look at the trend of survival over time. The plot provides

1.  survival probability\index{Survival probability} on the $y-axis$
2.  time on the $x-axis$


```r
library(paletteer)
p1<-ggsurvplot(KM_str_type2, 
           data = stroke,
           palette = paletteer_d("ggsci::light_blue_material")[seq(2,10,2)], 
                 size = 1.2, conf.int = FALSE, 
                 legend.labs = levels(stroke$stroke_type),
                 legend.title = "",
                 ggtheme = theme_minimal() + 
             theme(plot.title = element_text(face = "bold")),
                 title = "Probability of dying",
                 xlab = "Time",
                 ylab = "Probability of dying",
                 legend = "bottom", censor = FALSE)

p1$plot +
  scale_x_continuous(expand = c(0, 0), breaks = seq(1,43,1),
                     labels = seq(1,43,1),
                     limits = c(0, 820)) +
  scale_y_continuous(expand = c(0, 0), breaks = seq(0,1,0.2),
                     labels = scales::percent_format(accuracy = 1)) +
  theme_classic() +
  theme(legend.position = c(0.9,0.8),
        legend.background = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.grid.major = element_line(size = .2, colour = "grey90"),
        panel.grid.minor = element_line(size = .2, colour = "grey90"))
```

```
## Scale for x is already present.
## Adding another scale for x, which will replace the existing scale.
## Scale for y is already present.
## Adding another scale for y, which will replace the existing scale.
```

```
## Warning: The `size` argument of `element_line()` is deprecated as of ggplot2 3.4.0.
## i Please use the `linewidth` argument instead.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was
## generated.
```

<img src="staticunnamed-chunk-8-1.png" width="672" />




We can perform the Kaplan-Meier\index{Kaplan-Meier} estimates for variable dm too: 


```r
KM_dm <- survfit(Surv(time = time2, 
                      event = status == "dead" ) ~ dm,
                 data = stroke)
summary(KM_dm)
```

```
## Call: survfit(formula = Surv(time = time2, event = status == "dead") ~ 
##     dm, data = stroke)
## 
##                 dm=no 
##  time n.risk n.event survival std.err lower 95% CI upper 95% CI
##     1    141       8    0.943  0.0195       0.9058        0.982
##     2    122       4    0.912  0.0242       0.8661        0.961
##     3    102       2    0.894  0.0268       0.8434        0.949
##     4     82       2    0.873  0.0303       0.8152        0.934
##     5     54       5    0.792  0.0441       0.7100        0.883
##     6     40       3    0.732  0.0524       0.6366        0.843
##     7     34       2    0.689  0.0575       0.5854        0.812
##    10     24       1    0.661  0.0619       0.5498        0.794
##    12     20       4    0.529  0.0771       0.3971        0.703
##    18     13       1    0.488  0.0812       0.3521        0.676
##    22      9       1    0.434  0.0884       0.2908        0.647
##    25      4       1    0.325  0.1149       0.1627        0.650
##    29      3       1    0.217  0.1171       0.0752        0.625
## 
##                 dm=yes 
##  time n.risk n.event survival std.err lower 95% CI upper 95% CI
##     1     72       1    0.986  0.0138       0.9594        1.000
##     3     64       2    0.955  0.0253       0.9070        1.000
##     4     48       2    0.915  0.0367       0.8463        0.990
##     7     22       2    0.832  0.0653       0.7137        0.971
##     9     15       1    0.777  0.0811       0.6330        0.953
##    14      9       2    0.604  0.1248       0.4030        0.906
##    25      5       1    0.483  0.1471       0.2662        0.878
##    28      2       1    0.242  0.1860       0.0534        1.000
##    41      1       1    0.000     NaN           NA           NA
```

And then we can plot the survival estimates for patients with and without diabetes:


```r
p2<-ggsurvplot(KM_dm, 
           data = stroke, 
                 palette = paletteer_c("grDevices::Set 2", 12), 
                 size = 1.2, conf.int = FALSE,
                 legend.labs = levels(stroke$dm),
                 legend.title = "",
                 ggtheme = theme_minimal() + 
             theme(plot.title = element_text(face = "bold")),
                 title = "Probability of dying",
                 xlab = "Time till discharge",
                 ylab = "Probability of dying",
                 legend = "bottom", censor = FALSE)
```


```r
p2
```

<img src="staticunnamed-chunk-11-1.png" width="672" />


# Comparing Kaplan-Meier\index{Kaplan-Meier} estimates across groups 

There are a number of available tests to compare the survival estimates between groups based on KM. The tests include: 

1.  log-rank\index{Log-rank test} (default)
2.  peto-peto test\index{Peto-peto test}


### Log-rank test\index{Log-rank test}

to answer question if the survival estimates are different between levels or groups we can use statistical tests for example the log rank and the peto-peto tests\index{Peto-peto test}.

For all the test, the null hypothesis is that that the survival estimates between levels or groups are not different. For example, to do that:

#


```r
>survdiff(Surv(time = time2, 
              event = status == "dead") ~ stroke_type, 
         data = stroke,
         rho = 0)
Call:
survdiff(formula = Surv(time = time2, event = status == "dead") ~ 
    stroke_type, data = stroke, rho = 0)

                 N Observed Expected (O-E)^2/E (O-E)^2/V
stroke_type=HS  69       31     24.2      1.92      4.51
stroke_type=IS 144       17     23.8      1.95      4.51

 Chisq= 4.5  on 1 degrees of freedom, p= 0.03 
```

> The survival estimates between the stroke types (*IS* vs *HS* groups) are different at the level of $5\%$ significance (p-value = 0.03). 

# *And for the survival estimates based on diabetes status:*


```r
>survdiff(Surv(time = time2, 
              event = status == "dead") ~ dm, 
         data = stroke,
         rho = 0)
Call:
survdiff(formula = Surv(time = time2, event = status == "dead") ~ 
    dm, data = stroke, rho = 0)

         N Observed Expected (O-E)^2/E (O-E)^2/V
dm=no  141       35     29.8     0.919      2.54
dm=yes  72       13     18.2     1.500      2.54

 Chisq= 2.5  on 1 degrees of freedom, p= 0.1 
```

The survival estimates between patients with and without diabetes (dm status *yes* vs *no* groups) are not different (p-value = 0.1). 



# cox proportional hazards in survival analysis
##

If we want to compare the survival experience of stroke patients on different types of stroke (Ischaemic stroke vs Haemorrhagic stroke), one form of a regression model for the hazard function that addresses the study goal is cox proportional hazards model.



# Model Building
##
+ first build a model with all varibles


```r
>stroke_stype <- coxph(Surv(time2,status == 'dead') ~ gcs + stroke_type
                      + sex + dm + sbp ,data = stroke)
>summary(stroke_stype)
Call:
coxph(formula = Surv(time2, status == "dead") ~ gcs + stroke_type + 
    sex + dm + sbp, data = stroke)

  n= 213, number of events= 48 

                   coef exp(coef)  se(coef)      z Pr(>|z|)    
gcs           -0.170038  0.843633  0.037167 -4.575 4.76e-06 ***
stroke_typeIS -0.103523  0.901655  0.346749 -0.299    0.765    
sexmale       -0.203488  0.815880  0.334159 -0.609    0.543    
dmyes         -0.439913  0.644093  0.343960 -1.279    0.201    
sbp           -0.001765  0.998237  0.004017 -0.439    0.660    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
```

```r
              exp(coef) exp(-coef) lower .95 upper .95
gcs              0.8436      1.185    0.7844    0.9074
stroke_typeIS    0.9017      1.109    0.4570    1.7791
sexmale          0.8159      1.226    0.4238    1.5706
dmyes            0.6441      1.553    0.3282    1.2639
sbp              0.9982      1.002    0.9904    1.0061

Concordance= 0.78  (se = 0.035 )
Likelihood ratio test= 28.88  on 5 df,   p=2e-05
Wald test            = 27.71  on 5 df,   p=4e-05
Score (logrank) test = 31.45  on 5 df,   p=8e-06
```

#
##
- the estimate which is the log hazard. If you exponentiate it, you will get hazard ratio
- the standard error
- the p-value
- the confidence intervals for the log hazard

#
##


```r
stroke_stype <- coxph(Surv(time2,status == 'dead') ~ gcs + stroke_type+dbp+wbc
                      + sex + dm + sbp ,data = stroke)
tidy(stroke_stype,
     exponentiate = TRUE) 
```

```
## # A tibble: 7 x 5
##   term          estimate std.error statistic    p.value
##   <chr>            <dbl>     <dbl>     <dbl>      <dbl>
## 1 gcs              0.839   0.0391     -4.48  0.00000740
## 2 stroke_typeIS    0.892   0.349      -0.329 0.742     
## 3 dbp              0.988   0.0119     -1.00  0.317     
## 4 wbc              1.01    0.0389      0.269 0.788     
## 5 sexmale          0.862   0.350      -0.423 0.672     
## 6 dmyes            0.632   0.364      -1.26  0.208     
## 7 sbp              1.00    0.00691     0.529 0.597
```

# using rms package


```r
fatal_mv1<-rms::cph(Surv(time2,status == 'dead') ~ gcs + stroke_type+dbp+wbc
                      + sex + dm + sbp ,data = stroke)
```

```r
plot(anova(fatal_mv1),margin=c("chisq","d.f","P"))
```

<img src="staticunnamed-chunk-18-1.png" width="672" />


# now we create univariate models as in logistic regression

By using `tbl_uvregression()` we can generate simple univariable model for all covariates in one line of code. In return, we get the crude HR for all the covariates of interest.


```r
library(gt)
```

```
## 
## Attaching package: 'gt'
```

```
## The following object is masked from 'package:Hmisc':
## 
##     html
```

```r
library(gtsummary)
```

```
## #BlackLivesMatter
```

```r
stroke |>
  dplyr::select(time2, status, sex, dm, gcs, sbp, dbp, wbc, 
                stroke_type) |>
  tbl_uvregression(
    method = coxph,
    y = Surv(time2, event = status == 'dead'),
    exponentiate = TRUE,
    pvalue_fun = ~style_pvalue(.x, digits = 3)
  ) |>
  as_gt()
```

```
## Warning in writeBin(charToRaw(enc2utf8(text)), ...): problem writing to
## connection
```

```{=html}
<div id="kdenahsgxm" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#kdenahsgxm .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#kdenahsgxm .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#kdenahsgxm .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#kdenahsgxm .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#kdenahsgxm .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#kdenahsgxm .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#kdenahsgxm .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#kdenahsgxm .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#kdenahsgxm .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#kdenahsgxm .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#kdenahsgxm .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#kdenahsgxm .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#kdenahsgxm .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#kdenahsgxm .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#kdenahsgxm .gt_from_md > :first-child {
  margin-top: 0;
}

#kdenahsgxm .gt_from_md > :last-child {
  margin-bottom: 0;
}

#kdenahsgxm .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#kdenahsgxm .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#kdenahsgxm .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#kdenahsgxm .gt_row_group_first td {
  border-top-width: 2px;
}

#kdenahsgxm .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#kdenahsgxm .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#kdenahsgxm .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#kdenahsgxm .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#kdenahsgxm .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#kdenahsgxm .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#kdenahsgxm .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#kdenahsgxm .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#kdenahsgxm .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#kdenahsgxm .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#kdenahsgxm .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#kdenahsgxm .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#kdenahsgxm .gt_left {
  text-align: left;
}

#kdenahsgxm .gt_center {
  text-align: center;
}

#kdenahsgxm .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#kdenahsgxm .gt_font_normal {
  font-weight: normal;
}

#kdenahsgxm .gt_font_bold {
  font-weight: bold;
}

#kdenahsgxm .gt_font_italic {
  font-style: italic;
}

#kdenahsgxm .gt_super {
  font-size: 65%;
}

#kdenahsgxm .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

#kdenahsgxm .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#kdenahsgxm .gt_indent_1 {
  text-indent: 5px;
}

#kdenahsgxm .gt_indent_2 {
  text-indent: 10px;
}

#kdenahsgxm .gt_indent_3 {
  text-indent: 15px;
}

#kdenahsgxm .gt_indent_4 {
  text-indent: 20px;
}

#kdenahsgxm .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="&lt;strong&gt;Characteristic&lt;/strong&gt;"><strong>Characteristic</strong></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="&lt;strong&gt;N&lt;/strong&gt;"><strong>N</strong></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="&lt;strong&gt;HR&lt;/strong&gt;&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;"><strong>HR</strong><sup class="gt_footnote_marks">1</sup></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="&lt;strong&gt;95% CI&lt;/strong&gt;&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;"><strong>95% CI</strong><sup class="gt_footnote_marks">1</sup></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="&lt;strong&gt;p-value&lt;/strong&gt;"><strong>p-value</strong></th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="label" class="gt_row gt_left">sex</td>
<td headers="stat_n" class="gt_row gt_center">213</td>
<td headers="estimate" class="gt_row gt_center"></td>
<td headers="ci" class="gt_row gt_center"></td>
<td headers="p.value" class="gt_row gt_center"></td></tr>
    <tr><td headers="label" class="gt_row gt_left">    female</td>
<td headers="stat_n" class="gt_row gt_center"></td>
<td headers="estimate" class="gt_row gt_center">—</td>
<td headers="ci" class="gt_row gt_center">—</td>
<td headers="p.value" class="gt_row gt_center"></td></tr>
    <tr><td headers="label" class="gt_row gt_left">    male</td>
<td headers="stat_n" class="gt_row gt_center"></td>
<td headers="estimate" class="gt_row gt_center">0.71</td>
<td headers="ci" class="gt_row gt_center">0.37, 1.36</td>
<td headers="p.value" class="gt_row gt_center">0.299</td></tr>
    <tr><td headers="label" class="gt_row gt_left">dm</td>
<td headers="stat_n" class="gt_row gt_center">213</td>
<td headers="estimate" class="gt_row gt_center"></td>
<td headers="ci" class="gt_row gt_center"></td>
<td headers="p.value" class="gt_row gt_center"></td></tr>
    <tr><td headers="label" class="gt_row gt_left">    no</td>
<td headers="stat_n" class="gt_row gt_center"></td>
<td headers="estimate" class="gt_row gt_center">—</td>
<td headers="ci" class="gt_row gt_center">—</td>
<td headers="p.value" class="gt_row gt_center"></td></tr>
    <tr><td headers="label" class="gt_row gt_left">    yes</td>
<td headers="stat_n" class="gt_row gt_center"></td>
<td headers="estimate" class="gt_row gt_center">0.60</td>
<td headers="ci" class="gt_row gt_center">0.31, 1.13</td>
<td headers="p.value" class="gt_row gt_center">0.112</td></tr>
    <tr><td headers="label" class="gt_row gt_left">gcs</td>
<td headers="stat_n" class="gt_row gt_center">213</td>
<td headers="estimate" class="gt_row gt_center">0.84</td>
<td headers="ci" class="gt_row gt_center">0.79, 0.90</td>
<td headers="p.value" class="gt_row gt_center"><0.001</td></tr>
    <tr><td headers="label" class="gt_row gt_left">sbp</td>
<td headers="stat_n" class="gt_row gt_center">213</td>
<td headers="estimate" class="gt_row gt_center">1.00</td>
<td headers="ci" class="gt_row gt_center">0.99, 1.01</td>
<td headers="p.value" class="gt_row gt_center">0.617</td></tr>
    <tr><td headers="label" class="gt_row gt_left">dbp</td>
<td headers="stat_n" class="gt_row gt_center">213</td>
<td headers="estimate" class="gt_row gt_center">1.00</td>
<td headers="ci" class="gt_row gt_center">0.98, 1.01</td>
<td headers="p.value" class="gt_row gt_center">0.772</td></tr>
    <tr><td headers="label" class="gt_row gt_left">wbc</td>
<td headers="stat_n" class="gt_row gt_center">213</td>
<td headers="estimate" class="gt_row gt_center">1.04</td>
<td headers="ci" class="gt_row gt_center">0.97, 1.11</td>
<td headers="p.value" class="gt_row gt_center">0.270</td></tr>
    <tr><td headers="label" class="gt_row gt_left">stroke_type</td>
<td headers="stat_n" class="gt_row gt_center">213</td>
<td headers="estimate" class="gt_row gt_center"></td>
<td headers="ci" class="gt_row gt_center"></td>
<td headers="p.value" class="gt_row gt_center"></td></tr>
    <tr><td headers="label" class="gt_row gt_left">    HS</td>
<td headers="stat_n" class="gt_row gt_center"></td>
<td headers="estimate" class="gt_row gt_center">—</td>
<td headers="ci" class="gt_row gt_center">—</td>
<td headers="p.value" class="gt_row gt_center"></td></tr>
    <tr><td headers="label" class="gt_row gt_left">    IS</td>
<td headers="stat_n" class="gt_row gt_center"></td>
<td headers="estimate" class="gt_row gt_center">0.52</td>
<td headers="ci" class="gt_row gt_center">0.28, 0.96</td>
<td headers="p.value" class="gt_row gt_center">0.037</td></tr>
  </tbody>
  
  <tfoot class="gt_footnotes">
    <tr>
      <td class="gt_footnote" colspan="5"><sup class="gt_footnote_marks">1</sup> HR = Hazard Ratio, CI = Confidence Interval</td>
    </tr>
  </tfoot>
</table>
</div>
```

#
+ it is clear that `gcs` has the least p-value hence can be included in the model first


```r
stroke_gcs <- coxph(Surv(time = time2,event = status == 'dead') ~ gcs,
                     data = stroke)
summary(stroke_gcs)
```

```
## Call:
## coxph(formula = Surv(time = time2, event = status == "dead") ~ 
##     gcs, data = stroke)
## 
##   n= 213, number of events= 48 
## 
##         coef exp(coef) se(coef)      z Pr(>|z|)    
## gcs -0.17454   0.83984  0.03431 -5.087 3.63e-07 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
##     exp(coef) exp(-coef) lower .95 upper .95
## gcs    0.8398      1.191    0.7852    0.8983
## 
## Concordance= 0.763  (se = 0.039 )
## Likelihood ratio test= 26.01  on 1 df,   p=3e-07
## Wald test            = 25.88  on 1 df,   p=4e-07
## Score (logrank) test = 29.33  on 1 df,   p=6e-08
```


The simple Cox PH model with covariate gcs shows that with each one unit increase in gcs, the crude log hazard for death changes by a factor of $-0.175$. 

# lets tidy it up


```r
tidy(stroke_gcs,
     exponentiate = TRUE,
     conf.int = TRUE)
```

```
## # A tibble: 1 x 7
##   term  estimate std.error statistic     p.value conf.low conf.high
##   <chr>    <dbl>     <dbl>     <dbl>       <dbl>    <dbl>     <dbl>
## 1 gcs      0.840    0.0343     -5.09 0.000000363    0.785     0.898
```

When we exponentiate the log HR, the simple Cox PH model shows that with each one unit increase in gcs, the crude risk for death decreases for about $16\%$ and the of decrease are between $95\% CI (0.785, 0.898)$. The relationship between stroke death and gcs is highly significant (p-value $< 0.0001$) when not adjusting for other covariates. 


# next up we add stroke type


```r
stroke_mv <- 
  coxph(Surv(time = time2, 
             event = status == 'dead') ~ stroke_type +  gcs , 
        data = stroke)
tidy(stroke_mv, exponentiate = TRUE, conf.int = TRUE)
```

```
## # A tibble: 2 x 7
##   term          estimate std.error statistic    p.value conf.low conf.high
##   <chr>            <dbl>     <dbl>     <dbl>      <dbl>    <dbl>     <dbl>
## 1 stroke_typeIS    0.774    0.323     -0.794 0.427         0.411     1.46 
## 2 gcs              0.846    0.0357    -4.68  0.00000290    0.789     0.908
```

# lets test if stroke type is worth it

```r
anova(stroke_mv,stroke_gcs,test="LRT")
```

```
## Analysis of Deviance Table
##  Cox model: response is  Surv(time = time2, event = status == "dead")
##  Model 1: ~ stroke_type + gcs
##  Model 2: ~ gcs
##    loglik  Chisq Df Pr(>|Chi|)
## 1 -187.48                     
## 2 -187.80 0.6422  1     0.4229
```
+ The variable is not significant

# we try another one 

```r
stroke_dm <- 
  coxph(Surv(time = time2, 
             event = status == 'dead') ~ dm +  gcs , 
        data = stroke)
tidy(stroke_dm, exponentiate = TRUE, conf.int = TRUE)
```

```
## # A tibble: 2 x 7
##   term  estimate std.error statistic     p.value conf.low conf.high
##   <chr>    <dbl>     <dbl>     <dbl>       <dbl>    <dbl>     <dbl>
## 1 dmyes    0.625    0.328      -1.43 0.152          0.329     1.19 
## 2 gcs      0.840    0.0347     -5.04 0.000000466    0.785     0.899
```

# lets test if dm is worth it

```r
anova(stroke_dm,stroke_gcs,test="LRT")
```

```
## Analysis of Deviance Table
##  Cox model: response is  Surv(time = time2, event = status == "dead")
##  Model 1: ~ dm + gcs
##  Model 2: ~ gcs
##    loglik Chisq Df Pr(>|Chi|)
## 1 -186.71                    
## 2 -187.80 2.181  1     0.1397
```
+ still not worth is it , we can go on and on...

# lets do a backward elimination

```r
fatal_mv1<-rms::cph(Surv(time2,status == 'dead') ~ gcs + stroke_type+dbp+wbc
                      + sex + dm + sbp ,data = stroke)
fastbw(fatal_mv1)
```

```
## 
##  Deleted     Chi-Sq d.f. P      Residual d.f. P      AIC  
##  wbc         0.07   1    0.7881 0.07     1    0.7881 -1.93
##  stroke_type 0.14   1    0.7130 0.21     2    0.9015 -3.79
##  sex         0.16   1    0.6934 0.36     3    0.9478 -5.64
##  sbp         0.39   1    0.5326 0.75     4    0.9447 -7.25
##  dbp         1.12   1    0.2897 1.87     5    0.8664 -8.13
##  dm          2.03   1    0.1542 3.90     6    0.6898 -8.10
## 
## Approximate Estimates after Deleting Factors
## 
##        Coef    S.E. Wald Z         P
## gcs -0.1762 0.03495 -5.041 4.635e-07
## 
## Factors in Final Model
## 
## [1] gcs
```


 


## Inference




## The proportional hazard assumption\index{Proportional hazard assumption}

### Risk constant over time

The most important assumption in Cox PH regression is the proportionality of the hazards over time. It refers to the requirement that, the hazard functions are multiplicatively related and that their ratio is constant over survival time or it simply says that the estimated HR do not depend on time. 

A check of the proportional hazards assumption can be done by looking at the parameter estimates $\beta_1, ..., \beta_q$ over time. And we can safely assume proportional hazards when the estimates don't vary much over time. In most settings, in order to test the PH assumption, we can employ two-step procedure for assessing: 

- calculate covariate specific tests and
- plot the scaled and smoothed scaled Schoenfeld residuals\index{Scaled Schoenfeld} obtained from the model.


### Test for PH assumption

In many statistical software, the null hypothesis of constant regression coefficients can be tested, both globally as well as for each covariate. In R, this can be done using the `cox.zph()` function from the **survival**\index{survival} package.



```r
stroke_zph <- cox.zph(stroke_mv, transform = 'km')
stroke_zph
```

```
##              chisq df    p
## stroke_type 1.0828  1 0.30
## gcs         0.0211  1 0.88
## GLOBAL      1.0860  2 0.58
```

The global test is not significant (p value = 0.65) and the p-value for each of the covariate is also larger than 0.05. These evidence support that the there risks are proportional over time. 



```r
stroke_zph_rank <- cox.zph(stroke_mv, transform = 'rank')
stroke_zph_rank
```

```
##             chisq df    p
## stroke_type  1.14  1 0.28
## gcs          1.78  1 0.18
## GLOBAL       2.31  2 0.32
```

### Plots to assess PH assumption

We can plots these residuals

- deviance\index{Deviance}
- Schoenfeld\index{Schoenfeld}
- scaled Schoenfeld\index{Scaled Schoenfeld}

For example, let's start with plotting the residuals


```r
ggcoxdiagnostics(stroke_mv, type = "deviance")
```

```
## Warning: `gather_()` was deprecated in tidyr 1.2.0.
## i Please use `gather()` instead.
## i The deprecated feature was likely used in the survminer package.
##   Please report the issue at <]8;;https://github.com/kassambara/survminer/issueshttps://github.com/kassambara/survminer/issues]8;;>.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was
## generated.
```

```
## `geom_smooth()` using formula = 'y ~ x'
```

<img src="staticunnamed-chunk-29-1.png" width="672" />

Now, we will use Schoenfeld\index{Schoenfeld}



```r
ggcoxdiagnostics(stroke_mv, type = "schoenfeld")
```

```
## `geom_smooth()` using formula = 'y ~ x'
```

<img src="staticunnamed-chunk-30-1.png" width="672" />



















